<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>å‰ç”°ç”ºé˜²ç½ãƒãƒƒãƒ—</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
</head>
<body>
  <h1>å‰ç”°ç”ºé˜²ç½ãƒãƒƒãƒ—</h1>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="script.js"></script>
</body>
  // --- åœ°å›³ã‚’å‰ç”°ç”ºã®ä¸­å¿ƒã«å›ºå®šã—ã¦è¡¨ç¤º ---
const map = L.map('map').setView([34.746, 138.255], 13);

// --- OpenStreetMap ã‚¿ã‚¤ãƒ«ã‚’è¨­å®š ---
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 18,
  attribution: 'Â© OpenStreetMap contributors'
}).addTo(map);

// --- ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ãƒãƒƒãƒ—ã«è¡¨ç¤º ---
let userMarker;

function showUserLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆï¼ˆé’è‰²ï¼‰
      if (userMarker) {
        userMarker.setLatLng([lat, lng]);
      } else {
        userMarker = L.marker([lat, lng], {
          icon: L.icon({
            iconUrl: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png',
            iconSize: [32, 32],
            iconAnchor: [16, 32]
          })
        }).addTo(map).bindPopup("ğŸ“ ç¾åœ¨åœ° / Your Location").openPopup();
      }

      // åœ°å›³ã‚’ç¾åœ¨åœ°ã«ã‚ºãƒ¼ãƒ ã‚¤ãƒ³
      map.setView([lat, lng], 15);

      // ä¸€ç•ªè¿‘ã„é¿é›£æ‰€ã‚’æ¢ã™
      findNearestShelter(lat, lng);
    }, error => {
      alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ä½ç½®æƒ…å ±ã‚’è¨±å¯ã—ã¦ãã ã•ã„ã€‚");
    });
  } else {
    alert("ã“ã®ç«¯æœ«ã§ã¯ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚");
  }
}

// --- 2åˆ†ã”ã¨ã«ç¾åœ¨åœ°ã‚’æ›´æ–° ---
setInterval(showUserLocation, 120000);
showUserLocation();

// --- é¿é›£æ‰€ãƒ‡ãƒ¼ã‚¿ï¼ˆAã€œRï¼‹ãƒ›ãƒ†ãƒ«ãƒ—ãƒ¬ã‚¹ãƒˆãƒ³ï¼‰---
const shelters = [
  { name_ja: "æ´¥æ³¢é¿é›£ã‚¿ãƒ¯ãƒ¼A", name_en: "Tsunami Evacuation Tower A", lat: 34.746319, lng: 138.247944, capacity: 500, type: "tower" },
  { name_ja: "æ´¥æ³¢é¿é›£ã‚¿ãƒ¯ãƒ¼B", name_en: "Tsunami Evacuation Tower B", lat: 34.750227, lng: 138.251965, capacity: 500, type: "tower" },
  { name_ja: "æ´¥æ³¢é¿é›£ã‚¿ãƒ¯ãƒ¼C", name_en: "Tsunami Evacuation Tower C", lat: 34.751166, lng: 138.256964, capacity: 1100, type: "tower" },
  { name_ja: "æ´¥æ³¢é¿é›£ã‚¿ãƒ¯ãƒ¼D", name_en: "Tsunami Evacuation Tower D", lat: 34.754471, lng: 138.259400, capacity: 900, type: "tower" },
  { name_ja: "æ´¥æ³¢é¿é›£ã‚¿ãƒ¯ãƒ¼G", name_en: "Tsunami Evacuation Tower G", lat: 34.760645, lng: 138.271097, capacity: 700, type: "tower" },
  { name_ja: "æ´¥æ³¢é¿é›£ã‚¿ãƒ¯ãƒ¼K", name_en: "Tsunami Evacuation Tower K", lat: 34.755232, lng: 138.254129, capacity: 1200, type: "tower" },
  { name_ja: "æ´¥æ³¢é¿é›£ã‚¿ãƒ¯ãƒ¼P", name_en: "Tsunami Evacuation Tower P", lat: 34.753871, lng: 138.248147, capacity: 1300, type: "tower" },
  { name_ja: "ãƒ›ãƒ†ãƒ«ãƒ—ãƒ¬ã‚¹ãƒˆãƒ³YOSHIDAï¼ˆå±‹ä¸Šãƒ»éå¸¸éšæ®µï¼‰", name_en: "Hotel Preston YOSHIDA (Roof & Stairs)", lat: 34.765695, lng: 138.251411, capacity: 517, type: "shelter" },
  { name_ja: "å‰ç”°ç”ºç«‹ä½å‰å°å­¦æ ¡ï¼ˆå±‹ä¸Šï¼‰", name_en: "Sumiyoshi Elementary School (Roof Shelter)", lat: 34.7695107, lng: 138.2530098, capacity: 1560, type: "shelter" }
];

// --- é¿é›£æ‰€ãƒãƒ¼ã‚«ãƒ¼ã‚’è¿½åŠ  ---
const shelterMarkers = [];
shelters.forEach(shelter => {
  const iconColor = shelter.type === "tower" ? "blue" : "green";
  const icon = L.icon({
    iconUrl: `https://maps.google.com/mapfiles/ms/icons/${iconColor}-dot.png`,
    iconSize: [32, 32],
    iconAnchor: [16, 32]
  });

  const marker = L.marker([shelter.lat, shelter.lng], { icon }).addTo(map);
  marker.bindPopup(`
    <b>${shelter.name_ja}</b><br>
    <i>${shelter.name_en}</i><br>
    ğŸ‘¥ ${shelter.capacity.toLocaleString()}äºº<br>
    Capacity: ${shelter.capacity.toLocaleString()} people
  `);
  shelterMarkers.push({ ...shelter, marker });
});

// --- æœ€ã‚‚è¿‘ã„é¿é›£æ‰€ã‚’æ¢ã™é–¢æ•° ---
function findNearestShelter(userLat, userLng) {
  let nearest = null;
  let minDistance = Infinity;

  shelters.forEach(shelter => {
    const distance = getDistance(userLat, userLng, shelter.lat, shelter.lng);
    if (distance < minDistance) {
      minDistance = distance;
      nearest = shelter;
    }
  });

  if (nearest) {
    L.polyline([[userLat, userLng], [nearest.lat, nearest.lng]], { color: 'red' }).addTo(map);
    alert(`ğŸš¨ ç¾åœ¨åœ°ã‹ã‚‰æœ€ã‚‚è¿‘ã„é¿é›£å ´æ‰€ã¯ã€Œ${nearest.name_ja}ã€ã§ã™ã€‚\nè·é›¢ï¼šç´„${minDistance.toFixed(2)} km`);
  }
}

// --- 2ç‚¹é–“ã®è·é›¢ï¼ˆkmï¼‰ã‚’æ±‚ã‚ã‚‹é–¢æ•° ---
function getDistance(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI / 180;
  const dLon = (lon2 - lon1) * Math.PI / 180;
  const a = Math.sin(dLat / 2) ** 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) ** 2;
  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
}
</html>

<button onclick="window.location.href='quiz.html'">é˜²ç½ã‚¯ã‚¤ã‚ºã¸</button>
<button onclick="window.location.href='goods.html'">é˜²ç½ã‚°ãƒƒã‚ºãƒšãƒ¼ã‚¸ã¸</button>
